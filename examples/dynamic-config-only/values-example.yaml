# Example: Helm values for DynamicConfig-only configuration
# This example shows how to generate sql_exporter config from a database DSN stored in a Kubernetes secret
# Useful when the database connection string is managed by another system (e.g., service broker, operator)
#
# Prerequisites:
#   1. Create a secret with database connection information:
#      kubectl create secret generic database-credentials \
#        --from-literal=dsn='username:password@hostname:5432/database?sslmode=disable'
#
# Usage:
#   helm install sql-exporter ../../helm -f values-example.yaml

image:
  repository: burningalchemist/sql_exporter
  tag: "0.18.6"

# Disable static config creation
createConfig: false

# Enable dynamic config generation from secret
dynamicConfig:
  enabled: true
  # Secret containing the database DSN
  secretName: database-credentials
  # Key within the secret containing the DSN
  secretKey: dsn
  # Database type (postgres, mysql, mssql, etc.)
  type: postgres
  # Template for sql_exporter.yml (DSN will be substituted at runtime)
  template: |
    global:
      scrape_timeout: 10s
      scrape_timeout_offset: 500ms
      min_interval: 0s
      max_connections: 3
      max_idle_connections: 3
    target:
      # __TYPE__ and __DSN__ are replaced by the init container
      data_source_name: __TYPE__://__DSN__
      collectors:
        - pg_stat_activity
        - pg_stat_database
    collectors:
      - collector_name: pg_stat_activity
        min_interval: 1m
        metrics:
          - metric_name: pg_stat_activity_count
            type: gauge
            help: 'Number of connections by state'
            key_labels:
              - state
            values:
              - count
            query: |
              SELECT
                state,
                COUNT(*) as count
              FROM pg_stat_activity
              WHERE state IS NOT NULL
              GROUP BY state

      - collector_name: pg_stat_database
        min_interval: 5m
        metrics:
          - metric_name: pg_stat_database_size_bytes
            type: gauge
            help: 'Database size in bytes'
            key_labels:
              - datname
            values:
              - size_bytes
            query: |
              SELECT
                datname,
                pg_database_size(datname) as size_bytes
              FROM pg_database
              WHERE datistemplate = false

# ServiceMonitor configuration for Prometheus Operator
# Note: This chart uses ServiceMonitor (enabled by default) for Prometheus discovery.
# The prometheus.io/* annotations are NOT needed and are ignored by Prometheus Operator.
serviceMonitor:
  enabled: true
  interval: 30s

# Resource limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

